{% extends 'main/base.html' %}
{% load static %}

{% block title %}Raw Signals - Project GCE 3{% endblock %}

{% block content %}
<div class="page-header">
    <h1>üìä Raw Signals</h1>
    <p>TradeStation CSV Exports Analysis with Trading System Integration</p>
</div>

<div class="signals-controls">
    <!-- Trading Systems Section -->
    <div class="card mb-3">
        <div class="card-header">
            <h3>‚öôÔ∏è Trading Systems</h3>
            <div class="header-actions">
                <button class="btn btn-secondary" onclick="loadTradingSystems()">üîÑ Refresh Systems</button>
                <a href="/admin/main/tradingsystem/" target="_blank" class="btn btn-primary">‚ûï Manage Systems</a>
            </div>
        </div>
        <div class="card-body">
            <div class="trading-system-selector">
                <label for="tradingSystemSelect">Select Trading System:</label>
                <select id="tradingSystemSelect" class="form-control" onchange="loadTradingSystem()">
                    <option value="">-- Select a trading system --</option>
                </select>
                <div class="system-info mt-2">
                    <div id="systemInfo" class="text-muted">No system selected</div>
                </div>
            </div>
            
            <!-- System Details -->
            <div id="systemDetails" class="mt-3" style="display: none;">
                <h5>üìä System Configuration</h5>
                <div id="systemConfigInfo"></div>
            </div>
        </div>
    </div>

    <!-- CSV Files Section -->
    <div class="card">
        <div class="card-header">
            <h3>üìÅ CSV Files</h3>
            <div class="header-actions">
                <button class="btn btn-secondary" onclick="refreshFileList()">üîÑ Refresh</button>
                <span class="directory-info">Directory: {{ ts_exports_dir }}</span>
            </div>
        </div>
        <div class="card-body">
            {% if not directory_exists %}
                <div class="alert alert-warning">
                    <strong>‚ö†Ô∏è Warning:</strong> TradeStation exports directory not found: {{ ts_exports_dir }}
                </div>
            {% endif %}
            
            <div class="file-selector">
                <label for="csvFileSelect">Select CSV File:</label>
                <select id="csvFileSelect" class="form-control" onchange="loadSelectedFile()">
                    <option value="">-- Select a file --</option>
                </select>
                <div class="file-info mt-2">
                    <span id="fileInfo" class="text-muted">No file selected</span>
                </div>
            </div>
            
            <!-- Validation Results -->
            <div id="validationResults" class="mt-3" style="display: none;">
                <h5>‚úÖ Validation Results</h5>
                <div id="validationContent"></div>
                <div class="validation-actions mt-2">
                    <button class="btn btn-success" onclick="processCSVFile()" id="processBtn" disabled>üîÑ Process CSV</button>
                    <button class="btn btn-info" onclick="viewProcessedData()" id="viewProcessedBtn" style="display: none;">ÔøΩ View Processed Data</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="signals-data" id="signalsData" style="display: none;">
    <div class="card">
        <div class="card-header">
            <h3 id="dataTitle">üìà Signal Data</h3>
            <div class="data-info">
                <span id="dataInfo" class="text-muted"></span>
            </div>
        </div>
        <div class="card-body">
            <div class="table-controls">
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="Search data..." class="form-control" onkeyup="filterTable()">
                </div>
                <div class="table-actions">
                    <button class="btn btn-primary" onclick="exportToCSV()">üíæ Export</button>
                    <button class="btn btn-secondary" onclick="downloadOriginal()">üì• Download Original</button>
                </div>
            </div>
            
            <div class="table-wrapper">
                <table id="signalsTable" class="table table-striped">
                    <thead id="tableHead">
                        <!-- Headers will be populated by JavaScript -->
                    </thead>
                    <tbody id="tableBody">
                        <!-- Data will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>
            
            <div class="table-pagination">
                <div class="pagination-info">
                    <span id="paginationInfo">Showing 0 of 0 rows</span>
                </div>
                <div class="pagination-controls">
                    <button class="btn btn-sm btn-secondary" onclick="previousPage()" id="prevBtn" disabled>Previous</button>
                    <span id="pageNumbers"></span>
                    <button class="btn btn-sm btn-secondary" onclick="nextPage()" id="nextBtn" disabled>Next</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let currentData = [];
let filteredData = [];
let currentPage = 1;
const rowsPerPage = 50;
let selectedFileName = '';
let selectedTradingSystem = null;
let validationResult = null;
let processedData = null;
let tradingSystems = [];

// Load file list and trading systems on page load
document.addEventListener('DOMContentLoaded', function() {
    loadTradingSystems();
    refreshFileList();
});

function loadTradingSystems() {
    fetch('/api/trading-systems/')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                tradingSystems = data.systems;
                updateTradingSystemSelect();
            } else {
                console.error('Error loading trading systems:', data.message);
                showAlert('error', 'Failed to load trading systems: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('error', 'Network error loading trading systems');
        });
}

function updateTradingSystemSelect() {
    const select = document.getElementById('tradingSystemSelect');
    select.innerHTML = '<option value="">-- Select a trading system --</option>';
    
    tradingSystems.forEach(system => {
        const option = document.createElement('option');
        option.value = system.id;
        option.textContent = `${system.name} (${system.symbol}) - ${system.timeframes_count} timeframes`;
        select.appendChild(option);
    });
}

function loadTradingSystem() {
    const select = document.getElementById('tradingSystemSelect');
    const systemId = select.value;
    
    if (systemId) {
        selectedTradingSystem = tradingSystems.find(s => s.id == systemId);
        updateSystemInfo();
        
        // Show system details
        document.getElementById('systemDetails').style.display = 'block';
        showSystemConfiguration();
        
        // Clear previous validation results
        hideValidationResults();
        hideProcessingActions();
        
        // Re-validate current file if selected
        if (selectedFileName) {
            validateCurrentFile();
        }
    } else {
        selectedTradingSystem = null;
        updateSystemInfo();
        document.getElementById('systemDetails').style.display = 'none';
        hideValidationResults();
        hideProcessingActions();
    }
}

function updateSystemInfo() {
    const infoDiv = document.getElementById('systemInfo');
    
    if (selectedTradingSystem) {
        infoDiv.innerHTML = `
            <div class="system-details">
                <strong>System:</strong> ${selectedTradingSystem.name}<br>
                <strong>Symbol:</strong> ${selectedTradingSystem.symbol}<br>
                <strong>System ID:</strong> ${selectedTradingSystem.system_sid}<br>
                <strong>Timeframes:</strong> ${selectedTradingSystem.timeframes_count}<br>
                <strong>Time Offset:</strong> ${selectedTradingSystem.time_offset_minutes} minutes<br>
                <strong>Created:</strong> ${selectedTradingSystem.created_at}
            </div>
        `;
    } else {
        infoDiv.textContent = 'No system selected';
    }
}

function validateCurrentFile() {
    if (!selectedTradingSystem || !selectedFileName) {
        return;
    }
    
    showAlert('info', 'Validating CSV file against trading system configuration...');
    
    const formData = new FormData();
    formData.append('filename', selectedFileName);
    
    fetch(`/api/trading-systems/${selectedTradingSystem.id}/validate-csv/`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        hideAlert();
        
        if (data.success) {
            showValidationResults(data);
            if (data.is_valid) {
                showProcessingActions();
            }
        } else {
            showAlert('error', 'Validation failed: ' + data.message);
        }
    })
    .catch(error => {
        hideAlert();
        console.error('Error:', error);
        showAlert('error', 'Network error during validation');
    });
}

function showValidationResults(data) {
    const resultsDiv = document.getElementById('validationResults');
    const summaryDiv = document.getElementById('validationSummary');
    const detailsDiv = document.getElementById('validationDetails');
    
    // Summary
    const isValid = data.is_valid;
    summaryDiv.innerHTML = `
        <div class="alert ${isValid ? 'alert-success' : 'alert-danger'}">
            <strong>${isValid ? '‚úÖ Valid' : '‚ùå Invalid'}:</strong> 
            File ${isValid ? 'is compatible' : 'has issues'} with trading system "${selectedTradingSystem.name}"
        </div>
    `;
    
    // Details
    let detailsHtml = '<div class="validation-details">';
    
    data.validation_results.forEach((result, index) => {
        const statusIcon = result.valid ? '‚úÖ' : '‚ùå';
        detailsHtml += `
            <div class="timeframe-validation ${result.valid ? 'valid' : 'invalid'}">
                <h6>${statusIcon} Timeframe ${index + 1}</h6>
        `;
        
        if (result.errors.length > 0) {
            detailsHtml += '<div class="errors"><strong>Errors:</strong><ul>';
            result.errors.forEach(error => {
                detailsHtml += `<li class="text-danger">${error}</li>`;
            });
            detailsHtml += '</ul></div>';
        }
        
        if (result.warnings.length > 0) {
            detailsHtml += '<div class="warnings"><strong>Warnings:</strong><ul>';
            result.warnings.forEach(warning => {
                detailsHtml += `<li class="text-warning">${warning}</li>`;
            });
            detailsHtml += '</ul></div>';
        }
        
        detailsHtml += '</div>';
    });
    
    detailsHtml += '</div>';
    detailsDiv.innerHTML = detailsHtml;
    
    resultsDiv.style.display = 'block';
}

function hideValidationResults() {
    document.getElementById('validationResults').style.display = 'none';
}

function showProcessingActions() {
    document.getElementById('processingActions').style.display = 'block';
}

function hideProcessingActions() {
    document.getElementById('processingActions').style.display = 'none';
}

function processCSVFile() {
    if (!selectedTradingSystem || !selectedFileName) {
        showAlert('error', 'Please select both a trading system and CSV file');
        return;
    }
    
    showAlert('info', 'Processing CSV file to JSON format...');
    
    const formData = new FormData();
    formData.append('filename', selectedFileName);
    
    fetch(`/api/trading-systems/${selectedTradingSystem.id}/process-csv/`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        hideAlert();
        
        if (data.success) {
            showAlert('success', `Successfully processed ${data.total_records} records from ${data.filename}`);
            
            // Update file info to show it's been processed
            const fileInfo = document.getElementById('fileInfo');
            fileInfo.innerHTML += '<br><span class="text-success">‚úÖ Processed to JSON</span>';
        } else {
            showAlert('error', 'Processing failed: ' + data.message);
        }
    })
    .catch(error => {
        hideAlert();
        console.error('Error:', error);
        showAlert('error', 'Network error during processing');
    });
}

function downloadProcessedData() {
    if (!selectedTradingSystem || !selectedFileName) {
        showAlert('error', 'Please select both a trading system and CSV file');
        return;
    }
    
    // Get the processed data
    fetch(`/api/trading-systems/${selectedTradingSystem.id}/`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const processedFile = data.system.data_files.find(file => file.filename === selectedFileName);
                if (processedFile && processedFile.json_data) {
                    // Create and download JSON file
                    const jsonContent = JSON.stringify(processedFile.json_data, null, 2);
                    const blob = new Blob([jsonContent], { type: 'application/json' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `processed_${selectedFileName.replace('.csv', '.json')}`;
                    a.click();
                    window.URL.revokeObjectURL(url);
                } else {
                    showAlert('error', 'No processed data found for this file');
                }
            } else {
                showAlert('error', 'Failed to get processed data: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('error', 'Network error getting processed data');
        });
}

function showAlert(type, message) {
    // Remove existing alerts
    const existingAlert = document.querySelector('.dynamic-alert');
    if (existingAlert) {
        existingAlert.remove();
    }
    
    const alertClass = type === 'error' ? 'alert-danger' : 
                     type === 'success' ? 'alert-success' : 
                     type === 'warning' ? 'alert-warning' : 'alert-info';
    
    const alertHtml = `
        <div class="alert ${alertClass} alert-dismissible fade show dynamic-alert" role="alert">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    `;
    
    // Insert at the top of the page content
    const pageHeader = document.querySelector('.page-header');
    pageHeader.insertAdjacentHTML('afterend', alertHtml);
}

function hideAlert() {
    const existingAlert = document.querySelector('.dynamic-alert');
    if (existingAlert) {
        existingAlert.remove();
    }
}

function refreshFileList() {
    fetch('/api/csv/files/')
        .then(response => response.json())
        .then(data => {
            const select = document.getElementById('csvFileSelect');
            select.innerHTML = '<option value="">-- Select a file --</option>';
            
            if (data.success && data.files) {
                data.files.forEach(file => {
                    const option = document.createElement('option');
                    option.value = file.name;
                    option.textContent = `${file.name} (${formatFileSize(file.size)}, ${new Date(file.modified).toLocaleDateString()})`;
                    
                    // Add data attributes for later use
                    option.setAttribute('data-size', file.size);
                    option.setAttribute('data-modified', file.modified);
                    
                    select.appendChild(option);
                });
                
                document.getElementById('fileInfo').textContent = `${data.files.length} files found`;
            } else {
                document.getElementById('fileInfo').textContent = 'No CSV files found';
            }
        })
        .catch(error => {
            console.error('Error loading file list:', error);
            document.getElementById('fileInfo').textContent = 'Error loading files';
        });
}

function loadSelectedFile() {
    const select = document.getElementById('csvFileSelect');
    const filename = select.value;
    
    if (!filename) {
        document.getElementById('signalsData').style.display = 'none';
        selectedFileName = '';
        hideValidationResults();
        return;
    }
    
    selectedFileName = filename;
    
    // Update file info
    const selectedOption = select.options[select.selectedIndex];
    const fileSize = selectedOption.getAttribute('data-size');
    const fileModified = selectedOption.getAttribute('data-modified');
    
    document.getElementById('fileInfo').innerHTML = `
        <strong>File:</strong> ${filename}<br>
        <strong>Size:</strong> ${formatFileSize(parseInt(fileSize))}<br>
        <strong>Modified:</strong> ${new Date(fileModified).toLocaleString()}
    `;
    
    // Clear previous validation results
    hideValidationResults();
    
    // If trading system is selected, validate the file
    if (selectedTradingSystem) {
        validateCurrentFile();
    }
    
    // Show loading state
    document.getElementById('dataTitle').textContent = '‚è≥ Loading...';
    document.getElementById('signalsData').style.display = 'block';
    
    fetch(`/api/csv/data/?filename=${encodeURIComponent(filename)}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                currentData = data.data;
                filteredData = [...currentData];
                
                displayTable(data.headers, data.data);
                
                document.getElementById('dataTitle').textContent = `üìà ${filename}`;
                document.getElementById('dataInfo').textContent = 
                    `${data.row_count} rows, Delimiter: "${data.delimiter}"`;
                
                currentPage = 1;
                updatePagination();
                
                // Validate against selected trading system if available
                if (selectedTradingSystem) {
                    validateCurrentFile();
                }
            } else {
                document.getElementById('dataTitle').textContent = '‚ùå Error';
                document.getElementById('dataInfo').textContent = data.message;
                document.getElementById('tableBody').innerHTML = 
                    '<tr><td colspan="100%" class="text-center text-danger">Error loading data</td></tr>';
            }
        })
        .catch(error => {
            console.error('Error loading CSV data:', error);
            document.getElementById('dataTitle').textContent = '‚ùå Network Error';
            document.getElementById('dataInfo').textContent = 'Failed to load data';
        });
}

function displayTable(headers, data) {
    const thead = document.getElementById('tableHead');
    const tbody = document.getElementById('tableBody');
    
    // Create headers
    thead.innerHTML = '';
    if (headers && headers.length > 0) {
        const headerRow = document.createElement('tr');
        headers.forEach(header => {
            const th = document.createElement('th');
            th.textContent = header;
            headerRow.appendChild(th);
        });
        thead.appendChild(headerRow);
    }
    
    // Display current page data
    displayCurrentPage();
}

function displayCurrentPage() {
    const tbody = document.getElementById('tableBody');
    tbody.innerHTML = '';
    
    const startIndex = (currentPage - 1) * rowsPerPage;
    const endIndex = Math.min(startIndex + rowsPerPage, filteredData.length);
    
    for (let i = startIndex; i < endIndex; i++) {
        const row = filteredData[i];
        const tr = document.createElement('tr');
        
        row.forEach(cell => {
            const td = document.createElement('td');
            td.textContent = cell || '';
            tr.appendChild(td);
        });
        
        tbody.appendChild(tr);
    }
    
    updatePaginationInfo();
}

function filterTable() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    
    if (!searchTerm) {
        filteredData = [...currentData];
    } else {
        filteredData = currentData.filter(row => 
            row.some(cell => 
                cell && cell.toString().toLowerCase().includes(searchTerm)
            )
        );
    }
    
    currentPage = 1;
    displayCurrentPage();
    updatePagination();
}

function updatePagination() {
    const totalPages = Math.ceil(filteredData.length / rowsPerPage);
    
    document.getElementById('prevBtn').disabled = currentPage <= 1;
    document.getElementById('nextBtn').disabled = currentPage >= totalPages;
    
    updatePaginationInfo();
}

function updatePaginationInfo() {
    const startIndex = (currentPage - 1) * rowsPerPage + 1;
    const endIndex = Math.min(currentPage * rowsPerPage, filteredData.length);
    const total = filteredData.length;
    
    document.getElementById('paginationInfo').textContent = 
        `Showing ${startIndex}-${endIndex} of ${total} rows`;
}

function previousPage() {
    if (currentPage > 1) {
        currentPage--;
        displayCurrentPage();
        updatePagination();
    }
}

function nextPage() {
    const totalPages = Math.ceil(filteredData.length / rowsPerPage);
    if (currentPage < totalPages) {
        currentPage++;
        displayCurrentPage();
        updatePagination();
    }
}

function exportToCSV() {
    if (!filteredData.length) {
        alert('No data to export');
        return;
    }
    
    // Get headers
    const headers = Array.from(document.querySelectorAll('#tableHead th')).map(th => th.textContent);
    
    // Create CSV content
    let csvContent = headers.join(',') + '\n';
    filteredData.forEach(row => {
        csvContent += row.map(cell => `"${cell || ''}"`).join(',') + '\n';
    });
    
    // Download
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `filtered_${selectedFileName}`;
    a.click();
    window.URL.revokeObjectURL(url);
}

function downloadOriginal() {
    if (!selectedFileName) {
        alert('No file selected');
        return;
    }
    
    // Create download link for original file
    window.open(`/api/csv/data/?filename=${encodeURIComponent(selectedFileName)}&download=1`);
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

function showSystemConfiguration() {
    if (!selectedTradingSystem) return;
    
    const configDiv = document.getElementById('systemConfigInfo');
    let configHtml = '<div class="timeframes-config">';
    
    selectedTradingSystem.timeframes.forEach((timeframe, index) => {
        configHtml += `
            <div class="timeframe-item">
                <h6>Timeframe ${index + 1}</h6>
                <div class="config-details">
                    <span><strong>Open:</strong> ${timeframe.open_column || 'N/A'}</span>
                    <span><strong>High:</strong> ${timeframe.high_column || 'N/A'}</span>
                    <span><strong>Low:</strong> ${timeframe.low_column || 'N/A'}</span>
                    <span><strong>Close:</strong> ${timeframe.close_column || 'N/A'}</span>
                    <span><strong>Volume:</strong> ${timeframe.volume_column || 'N/A'}</span>
                    <span><strong>DateTime:</strong> ${timeframe.datetime_column || 'N/A'}</span>
                </div>
            </div>
        `;
    });
    
    configHtml += '</div>';
    configDiv.innerHTML = configHtml;
}

function showValidationResults(data) {
    const resultsDiv = document.getElementById('validationResults');
    const contentDiv = document.getElementById('validationContent');
    
    let resultsHtml = `
        <div class="validation-summary">
            <div class="alert ${data.is_valid ? 'alert-success' : 'alert-danger'}">
                <strong>Validation ${data.is_valid ? 'Passed' : 'Failed'}</strong>
                ${data.is_valid ? '‚úÖ CSV file is compatible with the selected trading system' : '‚ùå CSV file has validation errors'}
            </div>
        </div>
    `;
    
    if (data.headers && data.headers.length > 0) {
        resultsHtml += `
            <div class="headers-info">
                <h6>CSV Headers (${data.headers.length})</h6>
                <div class="headers-list">
                    ${data.headers.map(header => `<span class="badge badge-secondary">${header}</span>`).join(' ')}
                </div>
            </div>
        `;
    }
    
    if (data.validation_results && data.validation_results.length > 0) {
        resultsHtml += '<div class="timeframe-validation">';
        
        data.validation_results.forEach((result, index) => {
            const statusClass = result.valid ? 'success' : 'danger';
            const statusIcon = result.valid ? '‚úÖ' : '‚ùå';
            
            resultsHtml += `
                <div class="validation-item alert alert-${statusClass}">
                    <h6>${statusIcon} Timeframe ${index + 1} ${result.valid ? 'Valid' : 'Invalid'}</h6>
            `;
            
            if (result.errors && result.errors.length > 0) {
                resultsHtml += '<div class="errors"><strong>Errors:</strong><ul>';
                result.errors.forEach(error => {
                    resultsHtml += `<li class="text-danger">${error}</li>`;
                });
                resultsHtml += '</ul></div>';
            }
            
            if (result.warnings && result.warnings.length > 0) {
                resultsHtml += '<div class="warnings"><strong>Warnings:</strong><ul>';
                result.warnings.forEach(warning => {
                    resultsHtml += `<li class="text-warning">${warning}</li>`;
                });
                resultsHtml += '</ul></div>';
            }
            
            resultsHtml += '</div>';
        });
        
        resultsHtml += '</div>';
    }
    
    contentDiv.innerHTML = resultsHtml;
    resultsDiv.style.display = 'block';
    
    // Update process button state
    const processBtn = document.getElementById('processBtn');
    processBtn.disabled = !data.is_valid;
}

function hideValidationResults() {
    document.getElementById('validationResults').style.display = 'none';
}

function processCSVFile() {
    if (!selectedTradingSystem || !selectedFileName) {
        showAlert('error', 'Please select both a trading system and CSV file');
        return;
    }
    
    showAlert('info', 'Processing CSV file to JSON format...');
    
    const formData = new FormData();
    formData.append('filename', selectedFileName);
    
    fetch(`/api/trading-systems/${selectedTradingSystem.id}/process-csv/`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        hideAlert();
        
        if (data.success) {
            processedData = data.processed_data;
            showAlert('success', `Successfully processed ${data.total_records} records from ${data.filename}`);
            
            // Show view processed data button
            document.getElementById('viewProcessedBtn').style.display = 'inline-block';
        } else {
            showAlert('error', 'Processing failed: ' + data.message);
        }
    })
    .catch(error => {
        hideAlert();
        console.error('Error:', error);
        showAlert('error', 'Network error during processing');
    });
}

function viewProcessedData() {
    if (!processedData) {
        showAlert('error', 'No processed data available');
        return;
    }
    
    // Create a summary view of processed data
    const systemInfo = processedData.system_info;
    const timeframes = processedData.timeframes;
    
    let summaryHtml = `
        <div class="processed-data-summary">
            <h4>üìä Processed Data Summary</h4>
            <div class="system-summary">
                <strong>System:</strong> ${systemInfo.name} (${systemInfo.symbol})<br>
                <strong>System ID:</strong> ${systemInfo.system_sid}<br>
                <strong>Timeframes:</strong> ${systemInfo.timeframes_count}
            </div>
            <div class="timeframes-summary">
    `;
    
    Object.keys(timeframes).forEach(timeframeKey => {
        const tf = timeframes[timeframeKey];
        summaryHtml += `
            <div class="timeframe-summary">
                <h6>${timeframeKey}</h6>
                <p>Records: ${tf.data.length} | Valid: ${tf.statistics.valid_rows} | Invalid: ${tf.statistics.invalid_rows}</p>
            </div>
        `;
    });
    
    summaryHtml += '</div></div>';
    
    // Show in a modal or replace current data view
    const dataDiv = document.getElementById('signalsData');
    dataDiv.innerHTML = summaryHtml;
    dataDiv.style.display = 'block';
}

function showAlert(type, message) {
    // Remove existing alerts
    hideAlert();
    
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="close" onclick="hideAlert()">
            <span>&times;</span>
        </button>
    `;
    alertDiv.id = 'dynamicAlert';
    
    // Insert at the top of the content
    const content = document.querySelector('.signals-controls');
    content.insertBefore(alertDiv, content.firstChild);
}

function hideAlert() {
    const existingAlert = document.getElementById('dynamicAlert');
    if (existingAlert) {
        existingAlert.remove();
    }
}

function validateCurrentFile() {
    if (!selectedTradingSystem || !selectedFileName) {
        return;
    }
    
    showAlert('info', 'Validating CSV file against trading system configuration...');
    
    const formData = new FormData();
    formData.append('filename', selectedFileName);
    
    fetch(`/api/trading-systems/${selectedTradingSystem.id}/validate-csv/`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        hideAlert();
        
        if (data.success) {
            validationResult = data;
            showValidationResults(data);
        } else {
            showAlert('error', 'Validation failed: ' + data.message);
        }
    })
    .catch(error => {
        hideAlert();
        console.error('Error:', error);
        showAlert('error', 'Network error during validation');
    });
}
</script>
{% endblock %}