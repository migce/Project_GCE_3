{% extends 'main/base.html' %}

{% block title %}System Dashboard - Project GCE 3{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h2 class="card-title">‚öôÔ∏è System Dashboard</h2>
        <p class="card-subtitle">System components and connections monitoring</p>
    </div>
    
    <div class="dashboard-grid">
        <div class="metric-card">
            <div class="metric-value" style="color: {% if system_uptime %}#28a745{% else %}#dc3545{% endif %};">
                {{ system_uptime|default:"0" }}
            </div>
            <div class="metric-label">System Uptime</div>
        </div>
        <div class="metric-card">
            <div class="metric-value" style="color: {% if mt5_settings_count > 0 %}#28a745{% else %}#ffc107{% endif %};">
                {{ mt5_settings_count|default:"0" }}
            </div>
            <div class="metric-label">MT5 Settings</div>
        </div>
        <div class="metric-card">
            <div class="metric-value" style="color: #17a2b8;">
                {% if active_connections %}{{ active_connections }}{% else %}0{% endif %}
            </div>
            <div class="metric-label">Active Connections</div>
        </div>
        <div class="metric-card">
            <div class="metric-value" style="color: #6f42c1;">
                3
            </div>
            <div class="metric-label">System Modules</div>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <h3 class="card-title">üîç MT5 Monitoring Service</h3>
        <div style="float: right;">
            <button id="startMonitoringBtn" class="btn btn-success" onclick="startMonitoring()" style="display: none;">‚ñ∂Ô∏è Start Monitoring</button>
            <button id="stopMonitoringBtn" class="btn btn-danger" onclick="stopMonitoring()" style="display: none;">‚èπÔ∏è Stop Monitoring</button>
            <button class="btn btn-secondary" onclick="refreshMonitoringStatus()">üîÑ Refresh</button>
        </div>
        <div style="clear: both;"></div>
    </div>
    
    <div style="padding: 1.5rem;">
        <div class="dashboard-grid">
            <div class="metric-card">
                <div id="monitoringStatus" class="metric-value" style="color: #6c757d;">
                    ‚è≥ Loading...
                </div>
                <div class="metric-label">Service Status</div>
            </div>
            <div class="metric-card">
                <div id="healthCheckInterval" class="metric-value" style="color: #17a2b8;">
                    -
                </div>
                <div class="metric-label">Check Interval (sec)</div>
            </div>
            <div class="metric-card">
                <div id="autoReconnectStatus" class="metric-value" style="color: #17a2b8;">
                    -
                </div>
                <div class="metric-label">Auto-Reconnect</div>
            </div>
            <div class="metric-card">
                <div id="maxReconnectAttempts" class="metric-value" style="color: #17a2b8;">
                    -
                </div>
                <div class="metric-label">Max Reconnect Attempts</div>
            </div>
        </div>
        
        <div class="alert alert-info" style="margin-top: 1rem;">
            <strong>Info:</strong> The monitoring service automatically checks MT5 connections and attempts to reconnect when connections are lost.
        </div>
    </div>
</div>

<!-- Data Ingestion Service Card -->
<div class="card">
    <div class="card-header">
        <h3 class="card-title">üì• Data Ingestion Service</h3>
        <div style="float: right;">
            <button id="startIngestionBtn" class="btn btn-success" onclick="startIngestion()">Start</button>
            <button id="stopIngestionBtn" class="btn btn-danger" onclick="stopIngestion()">Stop</button>
            <button class="btn btn-secondary" onclick="refreshIngestionStatus()">Refresh</button>
            <button class="btn btn-secondary" onclick="openIngestionLogs()">Logs</button>
        </div>
        <div style="clear: both;"></div>
    </div>
    <div style="padding: 1.5rem;">
        <div class="dashboard-grid">
            <div class="metric-card">
                <div id="ingestionActive" class="metric-value" style="color:#6c757d">-</div>
                <div class="metric-label">Active</div>
            </div>
            <div class="metric-card">
                <div id="ingestionLastRun" class="metric-value">-</div>
                <div class="metric-label">Last Run</div>
            </div>
            <div class="metric-card">
                <div id="ingestionFilesScanned" class="metric-value">0</div>
                <div class="metric-label">Files Scanned</div>
            </div>
            <div class="metric-card">
                <div id="ingestionFilesImported" class="metric-value">0</div>
                <div class="metric-label">Files Imported</div>
            </div>
            <div class="metric-card">
                <div id="ingestionRowsImported" class="metric-value">0</div>
                <div class="metric-label">Rows Imported</div>
            </div>
            <div class="metric-card">
                <div id="ingestionHeartbeat" class="metric-value">-</div>
                <div class="metric-label">Heartbeat</div>
            </div>
            <div class="metric-card">
                <div id="ingestionHeartbeat" class="metric-value">-</div>
                <div class="metric-label">Heartbeat</div>
            </div>
        </div>
        <div class="alert alert-warning" id="ingestionLastError" style="display:none; margin-top: 1rem;"></div>
    </div>
    <script>
(function(){
  function getCookie(name){var v=null;if(document.cookie&&document.cookie!==''){var cs=document.cookie.split(';');for(var i=0;i<cs.length;i++){var c=cs[i].trim();if(c.substring(0,name.length+1)===(name+'=')){v=decodeURIComponent(c.substring(name.length+1));break;}}}return v;}
  function setText(id,val){var el=document.getElementById(id); if(el){el.textContent=val;}}
  window.refreshIngestionStatus=function(){
    fetch('/api/ingestion/status/',{credentials:'same-origin'})
      .then(function(r){return r.json();})
      .then(function(d){ if(!d||!d.success)return; var a=document.getElementById('ingestionActive'); if(a){a.textContent=d.active?'ON':'OFF'; a.style.color=d.active?'#28a745':'#dc3545';}
        setText('ingestionLastRun', d.last_run? new Date(d.last_run).toLocaleString() : '-');
        setText('ingestionFilesScanned', (d.files_scanned!=null?d.files_scanned:0));
        setText('ingestionFilesImported', (d.files_imported!=null?d.files_imported:0));
        setText('ingestionRowsImported', (d.rows_imported!=null?d.rows_imported:0));
        var e=document.getElementById('ingestionLastError'); if(e){ if(d.last_error){e.style.display='block'; e.textContent='Last error: '+d.last_error;} else {e.style.display='none'; e.textContent='';}}
        // Heartbeat: stale if last_run older than 2x scan_interval
        try {
          var hb = document.getElementById('ingestionHeartbeat');
          if (hb) {
            var ok = false;
            if (d.last_run) {
              var last = Date.parse(d.last_run);
              var now = Date.now();
              var intervalMs = (d.scan_interval || 5) * 1000;
              ok = (now - last) <= (2 * intervalMs);
            }
            hb.textContent = ok ? 'OK' : 'STALE';
            hb.style.color = ok ? '#28a745' : '#dc3545';
          }
        } catch (err) { /* noop */ }
      });
  };
  window.startIngestion=function(){
    fetch('/api/ingestion/start/',{method:'POST',credentials:'same-origin',headers:{'X-Requested-With':'XMLHttpRequest','X-CSRFToken':getCookie('csrftoken')}}).then(window.refreshIngestionStatus);
  };
  window.stopIngestion=function(){
    fetch('/api/ingestion/stop/',{method:'POST',credentials:'same-origin',headers:{'X-Requested-With':'XMLHttpRequest','X-CSRFToken':getCookie('csrftoken')}}).then(window.refreshIngestionStatus);
  };
  window.openIngestionLogs=function(){
    var m=document.getElementById('ingestionLogsModal'); if(m){m.style.display='block'; window.fetchIngestionLogs();}
  };
  window.closeIngestionLogs=function(){
    var m=document.getElementById('ingestionLogsModal'); if(m){m.style.display='none';}
  };
  window.fetchIngestionLogs=function(){
    var tbody=document.getElementById('ingestionLogsBody'); if(!tbody)return; tbody.innerHTML='<tr><td colspan="5" style="text-align:center; color:#6c757d;">Loading...</td></tr>';
    fetch('/api/ingestion/logs/',{credentials:'same-origin'})
      .then(function(r){return r.json();})
      .then(function(res){
        if(!res||!res.success){tbody.innerHTML='<tr><td colspan="5" style="text-align:center; color:#dc3545;">Failed to load logs</td></tr>'; return;}
        var rows=res.logs||[]; if(rows.length===0){tbody.innerHTML='<tr><td colspan="5" style="text-align:center; color:#6c757d;">No logs</td></tr>'; return;}
        var html = rows.map(function(l){
          var dt = l.created_at ? new Date(l.created_at).toLocaleString() : '-';
          var msg = (l.message||'').replace(/</g,'&lt;');
          return '<tr>'+
                 '<td>'+dt+'</td>'+
                 '<td title="'+l.filename+'">'+l.filename+'</td>'+
                 '<td>'+l.action+'</td>'+
                 '<td>'+(l.rows_imported!=null?l.rows_imported:0)+'</td>'+
                 '<td>'+msg+'</td>'+
                 '</tr>';
        }).join('');
        tbody.innerHTML = html;
      })
      .catch(function(){ tbody.innerHTML='<tr><td colspan="5" style="text-align:center; color:#dc3545;">Failed to load logs</td></tr>'; });
  };
  document.addEventListener('DOMContentLoaded',function(){window.refreshIngestionStatus(); setInterval(window.refreshIngestionStatus,5000);});
})();
</script>
    <!-- Ingestion Logs Modal -->
    <div id="ingestionLogsModal" style="display:none; position: fixed; left:0; right:0; top:0; bottom:0; background: rgba(0,0,0,0.5); z-index: 2000;">
        <div style="background:#fff; width:min(900px,95vw); margin:5vh auto; border-radius:8px; overflow:hidden;">
            <div style="padding:1rem 1.5rem; border-bottom:1px solid #eee; display:flex; align-items:center; justify-content:space-between;">
                <h4 style="margin:0;">Ingestion Logs (last 20)</h4>
                <div>
                    <button class="btn btn-secondary" onclick="fetchIngestionLogs()">Refresh</button>
                    <button class="btn btn-danger" onclick="closeIngestionLogs()">Close</button>
                </div>
            </div>
            <div style="padding:1rem 1.5rem; max-height:70vh; overflow:auto;">
                <table class="table" style="width:100%;">
                    <thead>
                        <tr>
                            <th style="width:22%;">Time</th>
                            <th style="width:34%;">File</th>
                            <th style="width:12%;">Action</th>
                            <th style="width:12%;">Rows</th>
                            <th style="width:20%;">Message</th>
                        </tr>
                    </thead>
                    <tbody id="ingestionLogsBody">
                        <tr><td colspan="5" style="text-align:center; color:#6c757d;">No data</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

<div class="card">
    <div class="card-header">
        <h3 class="card-title">üîå MetaTrader5 Connections</h3>
        <div style="float: right;">
            <button class="btn btn-primary" onclick="window.location.reload();">üîÑ Refresh Status</button>
        </div>
        <div style="clear: both;"></div>
    </div>
    
    {% if mt5_connections %}
        {% for connection in mt5_connections %}
        <div data-connection-id="{{ connection.id }}" style="background: #f8f9fa; padding: 1.5rem; margin: 1rem 0; border-radius: 8px; border-left: 4px solid {% if connection.is_connected %}#28a745{% else %}#dc3545{% endif %};">
            <div style="display: grid; grid-template-columns: 1fr auto; gap: 1rem; align-items: center;">
                <div>
                    <h4 style="margin-bottom: 0.5rem;">
                        {{ connection.name }}
                        <span class="status {% if connection.is_connected %}connected{% else %}disconnected{% endif %}">
                            {% if connection.is_connected %}‚úÖ Connected{% else %}‚ùå Disconnected{% endif %}
                        </span>
                    </h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-top: 1rem;">
                        <div>
                            <strong>Server:</strong> {{ connection.server|default:"Not specified" }}
                        </div>
                        <div>
                            <strong>Login:</strong> {{ connection.login|default:"Not specified" }}
                        </div>
                        <div data-field="balance">
                            <strong>Balance:</strong> 
                            {% if connection.balance %}
                                ${{ connection.balance|floatformat:2 }}
                            {% else %}
                                <span style="color: #6c757d;">Unavailable</span>
                            {% endif %}
                        </div>
                        <div data-field="equity">
                            <strong>Equity:</strong> 
                            {% if connection.equity %}
                                ${{ connection.equity|floatformat:2 }}
                            {% else %}
                                <span style="color: #6c757d;">Unavailable</span>
                            {% endif %}
                        </div>
                        <div data-field="last_update">
                            <strong>Last Update:</strong> 
                            <span style="color: #6c757d;">{{ connection.last_update|default:"Never" }}</span>
                        </div>
                    </div>
                    {% if connection.error_message %}
                        <div class="alert alert-danger" style="margin-top: 1rem;">
                            <strong>Error:</strong> {{ connection.error_message }}
                        </div>
                    {% endif %}
                </div>
                <div style="text-align: center;">
                    {% if connection.is_connected %}
                        <button class="btn btn-warning" 
                                onclick="disconnectMT5('{{ connection.id }}')"
                                id="btn-{{ connection.id }}">
                            üîå Disconnect
                        </button>
                    {% else %}
                        <button class="btn btn-success" 
                                onclick="connectMT5('{{ connection.id }}')"
                                id="btn-{{ connection.id }}">
                            üîó Connect
                        </button>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    {% else %}
        <div style="text-align: center; padding: 3rem; color: #6c757d;">
            <div style="font-size: 3rem; margin-bottom: 1rem;">üîß</div>
            <h4>–ü–æ–¥–∫–ª—é—á–µ–Ω–∏—è MetaTrader5 –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã</h4>
            <p>–î–æ–±–∞–≤—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –≤ –∞–¥–º–∏–Ω –ø–∞–Ω–µ–ª–∏ –¥–ª—è –Ω–∞—á–∞–ª–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞</p>
            <div style="margin-top: 1.5rem;">
                <a href="/admin/main/mt5settings/add/" class="btn btn-primary" target="_blank">
                    ‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ MT5
                </a>
            </div>
        </div>
    {% endif %}
</div>

<div class="card">
    <div class="card-header">
        <h3 class="card-title">üìä –°—Ç–∞—Ç—É—Å –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ —Å–∏—Å—Ç–µ–º—ã</h3>
    </div>
    
    <table class="table">
        <thead>
            <tr>
                <th style="width: 30%;">–ö–æ–º–ø–æ–Ω–µ–Ω—Ç</th>
                <th style="width: 20%;">–°—Ç–∞—Ç—É—Å</th>
                <th style="width: 30%;">–í–µ—Ä—Å–∏—è/–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</th>
                <th style="width: 20%;">–î–µ–π—Å—Ç–≤–∏–µ</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>
                    <strong>üåê Django Framework</strong><br>
                    <small style="color: #6c757d;">–í–µ–±-—Ñ—Ä–µ–π–º–≤–æ—Ä–∫</small>
                </td>
                <td>
                    <span class="status connected">‚úÖ –ê–∫—Ç–∏–≤–µ–Ω</span>
                </td>
                <td>
                    Django 5.2.6<br>
                    <small style="color: #6c757d;">Python {{ python_version }}</small>
                </td>
                <td>
                    <button class="btn btn-secondary" disabled>–†–∞–±–æ—Ç–∞–µ—Ç</button>
                </td>
            </tr>
            <tr>
                <td>
                    <strong>üìä MetaTrader5 Library</strong><br>
                    <small style="color: #6c757d;">–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</small>
                </td>
                <td>
                    {% if mt5_available %}
                        <span class="status connected">‚úÖ –î–æ—Å—Ç—É–ø–Ω–∞</span>
                    {% else %}
                        <span class="status disconnected">‚ùå –ù–µ–¥–æ—Å—Ç—É–ø–Ω–∞</span>
                    {% endif %}
                </td>
                <td>
                    {% if mt5_version %}{{ mt5_version }}{% else %}–ù–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞{% endif %}<br>
                    <small style="color: #6c757d;">–¢–µ—Ä–º–∏–Ω–∞–ª: {% if mt5_terminal_info %}{{ mt5_terminal_info }}{% else %}–ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω{% endif %}</small>
                </td>
                <td>
                    {% if mt5_available %}
                        <button class="btn btn-primary" onclick="testMT5Connection()">üîç –¢–µ—Å—Ç</button>
                    {% else %}
                        <button class="btn btn-secondary" disabled>–ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ</button>
                    {% endif %}
                </td>
            </tr>
            <tr>
                <td>
                    <strong>üíæ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö</strong><br>
                    <small style="color: #6c757d;">–•—Ä–∞–Ω–∏–ª–∏—â–µ –¥–∞–Ω–Ω—ã—Ö</small>
                </td>
                <td>
                    <span class="status connected">‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∞</span>
                </td>
                <td>
                    SQLite<br>
                    <small style="color: #6c757d;">{{ db_size|default:"–†–∞–∑–º–µ—Ä –Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω" }}</small>
                </td>
                <td>
                    <button class="btn btn-secondary" onclick="checkDatabase()">üîç –ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>
                </td>
            </tr>
        </tbody>
    </table>
</div>

<div class="card">
    <div class="card-header">
        <h3 class="card-title">‚ö° Quick Actions</h3>
    </div>
    
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
        <div style="padding: 1.5rem; background: #f8f9fa; border-radius: 8px; text-align: center;">
            <h4>üîß Settings Management</h4>
            <p style="color: #6c757d; margin: 1rem 0;">Configure MT5 connections</p>
            <a href="/admin/main/mt5connectionsettings/" class="btn btn-primary" target="_blank">Open Admin Panel</a>
        </div>
        <div style="padding: 1.5rem; background: #f8f9fa; border-radius: 8px; text-align: center;">
            <h4>üìà Trading History</h4>
            <p style="color: #6c757d; margin: 1rem 0;">View operations and statistics</p>
            <a href="{% url 'main:trading_history' %}" class="btn btn-primary">Go to History</a>
        </div>
        <div style="padding: 1.5rem; background: #f8f9fa; border-radius: 8px; text-align: center;">
            <h4>üè† Home Page</h4>
            <p style="color: #6c757d; margin: 1rem 0;">System overview</p>
            <a href="{% url 'main:home' %}" class="btn btn-primary">Go Home</a>
        </div>
    </div>
</div>

<script>
// Get CSRF token for AJAX requests
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

const csrftoken = getCookie('csrftoken');

// Function to connect to MT5
function connectMT5(settingsId) {
    const button = document.getElementById('btn-' + settingsId);
    const originalText = button.innerHTML;
    
    // Disable button and show loading state
    button.disabled = true;
    button.innerHTML = 'üîÑ Connecting...';
    
    fetch('{% url "main:mt5_connect" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': csrftoken,
        },
        body: 'settings_id=' + settingsId
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update connection status without full reload
            updateConnectionStatus(settingsId, true, data.balance, data.equity, data.last_update);
            
            // Show success message
            showMessage('Success: ' + data.message, 'success');
        } else {
            // Show error message
            showMessage('Error: ' + data.message, 'error');
            
            // Restore button
            button.disabled = false;
            button.innerHTML = originalText;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showMessage('Connection failed: ' + error.message, 'error');
        
        // Restore button
        button.disabled = false;
        button.innerHTML = originalText;
    });
}

// Function to update connection status in UI
function updateConnectionStatus(settingsId, isConnected, balance, equity, lastUpdate) {
    const container = document.querySelector(`[data-connection-id="${settingsId}"]`);
    if (!container) return;
    
    // Update status badge
    const statusElement = container.querySelector('.status');
    if (statusElement) {
        if (isConnected) {
            statusElement.className = 'status connected';
            statusElement.innerHTML = '‚úÖ Connected';
        } else {
            statusElement.className = 'status disconnected';
            statusElement.innerHTML = '‚ùå Disconnected';
        }
    }
    
    // Update balance
    const balanceElement = container.querySelector('[data-field="balance"]');
    if (balanceElement && balance !== null) {
        balanceElement.innerHTML = `<strong>Balance:</strong> $${parseFloat(balance).toFixed(2)}`;
    }
    
    // Update equity
    const equityElement = container.querySelector('[data-field="equity"]');
    if (equityElement && equity !== null) {
        equityElement.innerHTML = `<strong>Equity:</strong> $${parseFloat(equity).toFixed(2)}`;
    }
    
    // Update last update time
    const updateElement = container.querySelector('[data-field="last_update"]');
    if (updateElement && lastUpdate) {
        updateElement.innerHTML = `<strong>Last Update:</strong> <span style="color: #6c757d;">${lastUpdate}</span>`;
    }
    
    // Update button
    const button = document.getElementById('btn-' + settingsId);
    if (button) {
        button.disabled = false;
        if (isConnected) {
            button.innerHTML = 'üîå Disconnect';
            button.onclick = () => disconnectMT5(settingsId);
        } else {
            button.innerHTML = 'üîå Connect';
            button.onclick = () => connectMT5(settingsId);
        }
    }
}

// Function to show messages
function showMessage(message, type) {
    // Simple alert for now, can be improved with toast notifications
    alert(message);
}

// Function to disconnect from MT5
function disconnectMT5(settingsId) {
    const button = document.getElementById('btn-' + settingsId);
    const originalText = button.innerHTML;
    
    // Disable button and show loading state
    button.disabled = true;
    button.innerHTML = 'üîÑ Disconnecting...';
    
    fetch('{% url "main:mt5_disconnect" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': csrftoken,
        },
        body: 'settings_id=' + settingsId
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Show success message
            alert('Success: ' + data.message);
            // Reload page to update connection status
            window.location.reload();
        } else {
            // Show error message
            alert('Error: ' + data.message);
            // Restore button
            button.disabled = false;
            button.innerHTML = originalText;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Disconnection failed: ' + error.message);
        // Restore button
        button.disabled = false;
        button.innerHTML = originalText;
    });
}

// Legacy function for compatibility
function toggleConnection(connectionId) {
    alert('Please use the new Connect/Disconnect buttons for MT5 connections.');
}

function testMT5Connection() {
    alert('MT5 Connection Test...\nThis feature will be implemented in future versions.');
}

function checkDatabase() {
    alert('Database Check...\nEverything is OK! Database is working correctly.');
}

// Auto-refresh functionality
let autoRefreshInterval = null;
let autoRefreshEnabled = false;

function startAutoRefresh() {
    if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
    }
    
    autoRefreshInterval = setInterval(function() {
        updateAllConnectionsStatus();
    }, 5000); // Update every 5 seconds for better responsiveness
    
    autoRefreshEnabled = true;
    console.log('Auto-refresh started (every 5 seconds)');
}

function stopAutoRefresh() {
    if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
        autoRefreshInterval = null;
    }
    autoRefreshEnabled = false;
    console.log('Auto-refresh stopped');
}

function updateAllConnectionsStatus() {
    // Update MT5 connections status
    fetch('{% url "main:mt5_status_api" %}')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                data.connections.forEach(connection => {
                    updateConnectionDisplay(connection);
                });
                console.log('MT5 status updated at', new Date().toLocaleTimeString());
            } else {
                console.error('Failed to fetch MT5 status:', data.message);
            }
        })
        .catch(error => {
            console.error('Error updating MT5 status:', error);
        });
    
    // Update monitoring service status
    refreshMonitoringStatus();
}

function updateConnectionDisplay(connection) {
    const connectionDiv = document.querySelector(`[data-connection-id="${connection.id}"]`);
    if (!connectionDiv) return;
    
    // Update connection status indicator
    const statusSpan = connectionDiv.querySelector('.status');
    if (statusSpan) {
        statusSpan.className = connection.is_connected ? 'status connected' : 'status disconnected';
        statusSpan.innerHTML = connection.is_connected ? '‚úÖ Connected' : '‚ùå Disconnected';
    }
    
    // Update border color
    connectionDiv.style.borderLeftColor = connection.is_connected ? '#28a745' : '#dc3545';
    
    // Update balance
    const balanceDiv = connectionDiv.querySelector('[data-field="balance"]');
    if (balanceDiv) {
        const balanceText = connection.balance ? `$${parseFloat(connection.balance).toFixed(2)}` : '<span style="color: #6c757d;">Unavailable</span>';
        balanceDiv.innerHTML = `<strong>Balance:</strong> ${balanceText}`;
    }
    
    // Update equity
    const equityDiv = connectionDiv.querySelector('[data-field="equity"]');
    if (equityDiv) {
        const equityText = connection.equity ? `$${parseFloat(connection.equity).toFixed(2)}` : '<span style="color: #6c757d;">Unavailable</span>';
        equityDiv.innerHTML = `<strong>Equity:</strong> ${equityText}`;
    }
    
    // Update last update time
    const lastUpdateDiv = connectionDiv.querySelector('[data-field="last_update"]');
    if (lastUpdateDiv) {
        lastUpdateDiv.innerHTML = `<strong>Last Update:</strong> <span style="color: #6c757d;">${connection.last_update}</span>`;
    }
    
    // Update button
    const button = connectionDiv.querySelector(`#btn-${connection.id}`);
    if (button && !button.disabled) {
        if (connection.is_connected) {
            button.className = 'btn btn-warning';
            button.innerHTML = 'üîå Disconnect';
            button.onclick = function() { disconnectMT5(connection.id); };
        } else {
            button.className = 'btn btn-success';
            button.innerHTML = 'üîó Connect';
            button.onclick = function() { connectMT5(connection.id); };
        }
    }
    
    // Show/hide error messages
    let errorDiv = connectionDiv.querySelector('.alert-danger');
    if (connection.error_message) {
        if (!errorDiv) {
            errorDiv = document.createElement('div');
            errorDiv.className = 'alert alert-danger';
            errorDiv.style.marginTop = '1rem';
            connectionDiv.querySelector('div > div').appendChild(errorDiv);
        }
        errorDiv.innerHTML = `<strong>Error:</strong> ${connection.error_message}`;
    } else if (errorDiv) {
        errorDiv.remove();
    }
}

// Start auto-refresh when page loads
document.addEventListener('DOMContentLoaded', function() {
    startAutoRefresh();
    
    // Add toggle button for auto-refresh
    const refreshButton = document.querySelector('.btn-primary');
    if (refreshButton && refreshButton.textContent.includes('Refresh Status')) {
        const autoRefreshToggle = document.createElement('button');
        autoRefreshToggle.className = 'btn btn-secondary';
        autoRefreshToggle.style.marginLeft = '10px';
        autoRefreshToggle.innerHTML = '‚è∏Ô∏è Auto-refresh: ON';
        autoRefreshToggle.onclick = function() {
            if (autoRefreshEnabled) {
                stopAutoRefresh();
                this.innerHTML = '‚ñ∂Ô∏è Auto-refresh: OFF';
                this.className = 'btn btn-outline-secondary';
            } else {
                startAutoRefresh();
                this.innerHTML = '‚è∏Ô∏è Auto-refresh: ON';
                this.className = 'btn btn-secondary';
            }
        };
        refreshButton.parentNode.insertBefore(autoRefreshToggle, refreshButton.nextSibling);
    }
    
    // Load monitoring status on page load
    refreshMonitoringStatus();
});

// Monitoring control functions
function refreshMonitoringStatus() {
    console.log('Refreshing monitoring status...');
    
    fetch('/api/monitoring/status/')
        .then(response => {
            console.log('Status API response:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('Status API data:', data);
            if (data.success) {
                updateMonitoringDisplay(data);
            } else {
                console.error('Failed to get monitoring status:', data.message);
                showAlert('error', 'Failed to get monitoring status: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error fetching monitoring status:', error);
            showAlert('error', 'Network error while getting monitoring status');
        });
}

function updateMonitoringDisplay(data) {
    console.log('Updating monitoring display with data:', data);
    
    const statusElement = document.getElementById('monitoringStatus');
    const startBtn = document.getElementById('startMonitoringBtn');
    const stopBtn = document.getElementById('stopMonitoringBtn');
    
    if (!statusElement || !startBtn || !stopBtn) {
        console.error('Missing DOM elements for monitoring display');
        return;
    }
    
    // Update status display
    if (data.monitoring_active) {
        statusElement.innerHTML = 'üü¢ Running';
        statusElement.style.color = '#28a745';
        startBtn.style.display = 'none';
        stopBtn.style.display = 'inline-block';
        console.log('Set monitoring status to Running');
    } else {
        statusElement.innerHTML = 'üî¥ Stopped';
        statusElement.style.color = '#dc3545';
        startBtn.style.display = 'inline-block';
        stopBtn.style.display = 'none';
        console.log('Set monitoring status to Stopped');
    }
    
    // Update other metrics
    const healthCheckElement = document.getElementById('healthCheckInterval');
    const autoReconnectElement = document.getElementById('autoReconnectStatus');
    const maxAttemptsElement = document.getElementById('maxReconnectAttempts');
    
    if (healthCheckElement) healthCheckElement.innerHTML = data.health_check_interval || '-';
    if (autoReconnectElement) autoReconnectElement.innerHTML = data.auto_reconnect_enabled ? '‚úÖ Enabled' : '‚ùå Disabled';
    if (maxAttemptsElement) maxAttemptsElement.innerHTML = data.max_reconnect_attempts || '-';
}

function startMonitoring() {
    const startBtn = document.getElementById('startMonitoringBtn');
    startBtn.disabled = true;
    startBtn.innerHTML = '‚è≥ Starting...';
    
    fetch('/api/monitoring/start/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', data.message);
            // –ë—ã—Å—Ç—Ä–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –ø–æ—Å–ª–µ —Å—Ç–∞—Ä—Ç–∞
            setTimeout(() => {
                refreshMonitoringStatus();
                // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ —Å–µ–∫—É–Ω–¥—É –¥–ª—è —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏
                setTimeout(() => {
                    refreshMonitoringStatus();
                }, 1000);
            }, 200);
        } else {
            showAlert('error', data.message);
        }
    })
    .catch(error => {
        showAlert('error', 'Error starting monitoring service');
        console.error('Error:', error);
    })
    .finally(() => {
        startBtn.disabled = false;
        startBtn.innerHTML = '‚ñ∂Ô∏è Start Monitoring';
    });
}

function stopMonitoring() {
    const stopBtn = document.getElementById('stopMonitoringBtn');
    stopBtn.disabled = true;
    stopBtn.innerHTML = '‚è≥ Stopping...';
    
    fetch('/api/monitoring/stop/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', data.message);
            // –ë—ã—Å—Ç—Ä–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –ø–æ—Å–ª–µ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏
            setTimeout(() => {
                refreshMonitoringStatus();
                // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ —Å–µ–∫—É–Ω–¥—É –¥–ª—è —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏
                setTimeout(() => {
                    refreshMonitoringStatus();
                }, 1000);
            }, 200);
        } else {
            showAlert('error', data.message);
        }
    })
    .catch(error => {
        showAlert('error', 'Error stopping monitoring service');
        console.error('Error:', error);
    })
    .finally(() => {
        stopBtn.disabled = false;
        stopBtn.innerHTML = '‚èπÔ∏è Stop Monitoring';
    });
}
</script>
{% endblock %}
<div class="card">
    <div class="card-header">
        <h3 class="card-title">üì• Data Ingestion Service</h3>
        <div style="float: right;">
            <button id="startIngestionBtn" class="btn btn-success" onclick="startIngestion()">Start</button>
            <button id="stopIngestionBtn" class="btn btn-danger" onclick="stopIngestion()">Stop</button>
            <button class="btn btn-secondary" onclick="refreshIngestionStatus()">Refresh</button>
            <button class="btn btn-secondary" onclick="openIngestionLogs()">Logs</button>
        </div>
        <div style="clear: both;"></div>
    </div>
    <div style="padding: 1.5rem;">
        <div class="dashboard-grid">
            <div class="metric-card">
                <div id="ingestionActive" class="metric-value">-</div>
                <div class="metric-label">Active</div>
            </div>
            <div class="metric-card">
                <div id="ingestionLastRun" class="metric-value">-</div>
                <div class="metric-label">Last Run</div>
            </div>
            <div class="metric-card">
                <div id="ingestionFilesScanned" class="metric-value">0</div>
                <div class="metric-label">Files Scanned</div>
            </div>
            <div class="metric-card">
                <div id="ingestionFilesImported" class="metric-value">0</div>
                <div class="metric-label">Files Imported</div>
            </div>
            <div class="metric-card">
                <div id="ingestionRowsImported" class="metric-value">0</div>
                <div class="metric-label">Rows Imported</div>
            </div>
        </div>
        <div class="alert alert-warning" id="ingestionLastError" style="display:none; margin-top: 1rem;"></div>
    </div>
    <script>\n        // CSRF helper for Django\n        function getCookie(name) {\n            let cookieValue = null;\n            if (document.cookie && document.cookie !== '') {\n                const cookies = document.cookie.split(';');\n                for (let i = 0; i < cookies.length; i++) {\n                    const cookie = cookies[i].trim();\n                    if (cookie.substring(0, name.length + 1) === (name + '=')) {\n                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));\n                        break;\n                    }\n                }\n            }\n            return cookieValue;\n        }\n        function refreshIngestionStatus() {
            fetch('/api/ingestion/status/')
                .then(r => r.json())
                .then(data => {
                    if (!data.success) return;
                    document.getElementById('ingestionActive').textContent = data.active ? 'ON' : 'OFF';
                    document.getElementById('ingestionActive').style.color = data.active ? '#28a745' : '#dc3545';
                    document.getElementById('ingestionLastRun').textContent = data.last_run ? new Date(data.last_run).toLocaleString() : '-';
                    document.getElementById('ingestionFilesScanned').textContent = data.files_scanned ?? 0;
                    document.getElementById('ingestionFilesImported').textContent = data.files_imported ?? 0;
                    document.getElementById('ingestionRowsImported').textContent = data.rows_imported ?? 0;
                    const errBox = document.getElementById('ingestionLastError');
                    if (data.last_error) {
                        errBox.style.display = 'block';
                        errBox.textContent = 'Last error: ' + data.last_error;
                    } else {
                        errBox.style.display = 'none';
                        errBox.textContent = '';
                    }
                    try {
                        const hb = document.getElementById('ingestionHeartbeat');
                        if (hb) {
                            const intervalMs = (data.scan_interval || 5) * 1000;
                            const last = data.last_run ? Date.parse(data.last_run) : 0;
                            const ok = last && (Date.now() - last) <= (2 * intervalMs);
                            hb.textContent = ok ? 'OK' : 'STALE';
                            hb.style.color = ok ? '#28a745' : '#dc3545';
                        }
                    } catch (e) {}
                })
                .catch(() => {});
        }

        window.startIngestion = function(){
            fetch('/api/ingestion/start/', { method: 'POST', credentials: 'same-origin', headers: { 'X-Requested-With': 'XMLHttpRequest', 'X-CSRFToken': getCookie('csrftoken') } }).then(() => refreshIngestionStatus());
        }

        window.stopIngestion = function(){
            fetch('/api/ingestion/stop/', { method: 'POST', credentials: 'same-origin', headers: { 'X-Requested-With': 'XMLHttpRequest', 'X-CSRFToken': getCookie('csrftoken') } }).then(() => refreshIngestionStatus());
        }

        document.addEventListener('DOMContentLoaded', function () {
            refreshIngestionStatus();
            setInterval(refreshIngestionStatus, 5000);
        });
    </script>
</div>



